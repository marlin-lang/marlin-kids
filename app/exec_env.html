<!DOCTYPE html>
<html>
  <head>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
      }
      body {
        background: black;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      canvas {
        background: black;
      }
    </style>
    <script>
      function execute(func) {
        async function _exec() {
          // TODO: catch exceptions
          await { __thefunc__: func }.__thefunc__();
        }
        _exec();
      }

      function* range(first, second = undefined, third = undefined) {
        var begin = 0,
          end,
          step = 1;
        if (second != undefined) {
          begin = first;
          end = second;
          if (third != undefined) {
            step = third;
          }
        } else {
          end = first;
        }
        for (var i = begin; step >= 0 ? i < end : i > end; i += step) {
          yield i;
        }
      }

      async function sleep(time) {
        return new Promise(accept => {
          setTimeout(accept, time);
        });
      }

      function print(obj) {
        webkit.messageHandlers.system.postMessage({
          type: "log",
          message: String(obj)
        });
      }

      const graphics = {
        captureContext(canvas) {
          const newContext = canvas.getContext("2d");
          if (this.context == undefined) {
            // Default style
            newContext.strokeStyle = "#ffffff";
          } else {
            newContext.strokeStyle = this.context.strokeStyle;
            newContext.fillStyle = this.context.fillStyle;
            newContext.lineWidth = this.context.lineWidth;
            newContext.lineCap = this.context.lineCap;
            newContext.lineJoin = this.context.lineJoin;
            newContext.miterLimit = this.context.miterLimit;
            newContext.lineDashOffset = this.context.lineDashOffset;
            newContext.setLineDash(this.context.getLineDash());
          }
          this.context = newContext;
        },

        origin() {
          return {
            x: this.context.canvas.width / 2,
            y: this.context.canvas.height / 2
          };
        },

        async drawLine(startX, startY, endX, endY) {
          const origin = this.origin();
          this.context.beginPath();
          this.context.moveTo(startX + origin.x, startY + origin.y);
          this.context.lineTo(endX + origin.x, endY + origin.y);
          this.context.stroke();
          await sleep(0);
        }
      };

      const logo = {
        x: 0,
        y: 0,
        dir: 0,
        RAD_PER_DEG: Math.PI / 180,

        async forward(length) {
          const originalX = this.x;
          const originalY = this.y;
          this.x -= length * Math.sin(this.dir);
          this.y += length * Math.cos(this.dir);
          await graphics.drawLine(originalX, originalY, this.x, this.y);
        },

        async backward(length) {
          await forward(-length);
        },

        turnLeft(degree) {
          this.dir = (this.dir + degree * this.RAD_PER_DEG) % (Math.PI * 2);
        },

        turnRight(degree) {
          turnLeft(-degree);
        }
      };

      window.onload = () => {
        let canvas = document.getElementsByTagName("canvas")[0];
        canvas.width = document.body.scrollWidth;
        canvas.height = document.body.scrollHeight;

        graphics.captureContext(canvas);

        let resizeEnd;
        window.onresize = () => {
          clearTimeout(resizeEnd);
          resizeEnd = setTimeout(() => {
            const newCanvas = document.createElement("canvas");
            newCanvas.width = document.body.scrollWidth;
            newCanvas.height = document.body.scrollHeight;

            graphics.captureContext(newCanvas);
            graphics.context.drawImage(
              canvas,
              (newCanvas.width - canvas.width) / 2,
              (newCanvas.height - canvas.height) / 2
            );

            document.body.insertBefore(newCanvas, canvas);
            document.body.removeChild(canvas);
            canvas = newCanvas;
          }, 100);
        };
      };
    </script>
  </head>
  <body>
    <canvas></canvas>
  </body>
</html>
